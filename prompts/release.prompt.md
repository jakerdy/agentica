---
name: agentica.release
description: Подготовка релиза, сборка черновика changelog и предрелизный аудит
---

## Ввод пользователя

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учесть ввод пользователя (аргументы и контекст) перед тем как продолжить.

## Цель и принцип работы

Твоя задача — подготовить релизный пакет в формате `REL-vX.Y.Z`:
1. Проверить готовность репозитория к релизу.
2. Вычислить новую версию и собрать черновик `Changelog`.
3. Сформировать документ релиза по шаблону.
4. Выдать отчёт о рисках и командах публикации.

Работай строго линейно: **Проверка ветки → Выбор версии → Сбор коммитов → Предрелизный аудит → Генерация REL-документа → Отчёт**.

## Глобальные запреты (Safety Guards)

Останови выполнение и не вноси изменения, если:
1. Текущая ветка не `main` и не `master`.
2. Невозможно определить предыдущий релиз (нет тегов и нет версии в манифестах).
3. Репозиторий не является git-репозиторием.

В случае остановки: объясни причину, покажи минимальные шаги для исправления и предложи перезапустить `agentica.release`.

## Топология и размещение файлов

Документ релиза хранится в:
- `.agentica/release/REL-vX.Y.Z - <Release Name>.md`

Шаблон релиза:
- `.agentica/templates/release/REL-0000 - Release Name.md`

## Фаза 1: Проверка git-контекста

1. Проверь, что репозиторий git и текущая ветка через `run_in_terminal`:
   - `git rev-parse --is-inside-work-tree`
   - `git branch --show-current`
2. Если ветка не `main`/`master` — **STOP**.
3. Найди предыдущую версию:
   - сначала `git describe --tags --abbrev=0`
   - если тега нет, попробуй получить текущую версию из манифестов (`package.json`, `pyproject.toml`, `Cargo.toml`, и т.д. — по стеку проекта).

## Фаза 2: Вычисление новой версии

1. Спроси пользователя через `ask_questions` тип увеличения версии:
   - `patch`
   - `minor`
   - `major`
2. На основе предыдущей версии вычисли новую семантическую версию (`X.Y.Z`).
3. Определи новый release id как `REL-vX.Y.Z`.
4. Обнови версии в манифестах (но не коммить изменения):
   - `package.json` → `version`
   - `pyproject.toml` → `version`
   - и т.д. по стеку проекта.

## Фаза 3: Сбор changelog по коммитам

1. Собери коммиты с последнего тега до `HEAD`:
   - `git log <prev_tag>..HEAD --pretty=format:"%h|%s|%an|%ad" --date=short`
   - если тега нет: используй разумный диапазон (например, все коммиты текущей ветки).
2. Сгруппируй коммиты в черновик changelog:
   - Features
   - Fixes
   - Refactor/Chore
   - Docs/Test/Build
3. Пройдись по каждому коммиту и убери шум:
   - merge-коммиты
   - технические коммиты без продуктовой ценности (оставляй в отдельном блоке при необходимости).

## Фаза 4: Предрелизный аудит

Проверь и явно зафиксируй статус каждого пункта:

1. Версии в манифестах пакетов совпадают с вычисленной версией.
2. Все изменения закоммичены (`git status --porcelain` пустой).
3. Код форматируется, линтится, компилируется и собирается (команды брать из `tech.md`, `README.md`, `package.json`/`pyproject.toml`).
4. Dry-run публикации работает (если применимо стеку):
   - npm: `npm publish --dry-run`
   - bun: `bun publish --dry-run`
   - python: `python -m build` + `twine check dist/*` (или эквивалент)
5. Окружение для публикации настроено корректно:
   - наличие токенов/credentials (без вывода секретов)
   - корректный registry/repository endpoint

Если проверка неприменима к стеку — отмечай как `N/A` с коротким объяснением.

## Фаза 5: Генерация REL-документа

1. Создай новый файл по шаблону:
   - `.agentica/release/REL-vX.Y.Z - <Release Name>.md`
2. Заполни:
   - версию (`previous` → `next`)
   - дату
   - pre-release checklist
   - changelog draft
   - stack-oriented release plan
   - блок рисков и блокеров

## Фаза 6: Отчёт пользователю

Выдай короткий отчёт:
1. Какая версия рассчитана (`from` → `to`).
2. Где создан REL-документ.
3. Какие проверки пройдены/провалены/неприменимы.
4. Попроси пользователя проверить, всё ли ОК, и устранить блокеры, если они есть.

## Фаза 7: Помощь в публикации (по запросу)

Проведи всю предрелизную подготовку, но не выполняй публикацию. Вместо этого:
1. Апнуть версии в манифестах.
2. Закоммитить изменения с сообщением `chore(release): prepare vX.Y.Z`.
3. Создать тег `vX.Y.Z` и отправить его в origin.
4. Обновить Badges в `README.md` (если есть).
5. Дозаполнить `REL-vX.Y.Z` с реальными командами публикации и инструкциями по запуску, пройтись по всем чеклистам в последний раз.
6. Дописать все изменения из черновика changelog в `CHANGELOG.md` (если есть).
7. Написать финальную команду для публикации релиза и дать краткие инструкции по её запуску.

## Требования к качеству

1. Версия должна быть semver-валидной и согласованной между документом и манифестами.
2. Changelog должен строиться только из реальных коммитов диапазона релиза.
3. Если есть блокеры, команды публикации всё равно показать, но пометить как «не запускать до устранения блокеров».
4. Никакие секреты не выводить в отчёт.
