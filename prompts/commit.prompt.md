---
name: agentica.commit
description: Безопасная подготовка staged-изменений и создание семантического commit message
---

## Ввод пользователя

```text
$ARGUMENTS
```

Ты **ОБЯЗАН** учесть ввод пользователя (аргументы и контекст) перед тем как продолжить.

## Цель и принцип работы

Твоя задача — подготовить и выполнить коммит в безопасном режиме:
1. Добавить изменения в stage.
2. Проверить, что в stage нет лишних файлов, секретов и бинарного мусора.
3. Сформировать корректный commit message.
4. Выполнить `git commit`.

Работай строго линейно: **Диагностика → Stage → Проверка содержимого stage → Генерация commit message → Commit → Отчёт**.

## Глобальные запреты (Safety Guards)

Останови выполнение и не коммить, если:
1. Текущая директория не является git-репозиторием.
2. После staging обнаружены потенциальные секреты, и пользователь не подтвердил продолжение.
3. В stage есть нежелательные бинарные/сборочные артефакты, и пользователь не подтвердил продолжение.
4. В stage нет изменений (пустой коммит не запрошен явно).

В случае остановки: объясни причину и покажи, как исправить ситуацию.

## Фаза 1: Диагностика git-контекста

1. Проверь git-контекст:
   - `git rev-parse --is-inside-work-tree`
2. Собери текущее состояние:
   - `git status --short`

## Фаза 2: Stage всех изменений

1. Добавь все изменения в stage:
   - `git add -A`
2. Проверь staged-список:
   - `git diff --cached --name-status`

## Фаза 3: Проверка stage на риски

Если пользователь указал ключ `--skip-checks`, пропусти эту фазу и перейди к генерации commit message.

### 3.1 Поиск мусорных/артефактных файлов

Проверь staged-файлы на признаки артефактов и мусора (например):
- `*.exe`, `*.dll`, `*.dylib`, `*.so`, `*.a`, `*.o`, `*.obj`
- `*.tgz`, `*.zip`, `*.tar`, `*.gz`, `*.7z`
- <другие типы не похожие на исходники>
- фалйы большого размера (например, >5MB), если это не типичные для проекта ассеты.
- build-output и временные директории (`dist/`, `build/`, `.cache/`, `coverage/`, и т.д.), если они не должны коммититься по правилам проекта.

Если найдено:
1. Покажи пользователю список подозрительных файлов.
2. Предупреди, что эти файлы выглядят как мусор/артефакты/temp.
3. Предложи обновить `.gitignore` и убрать лишнее из stage.
4. Через `ask_questions` попроси выбрать действие:
   - убрать артефакты из stage и продолжить;
   - убрать и обновить `.gitignore`, затем продолжить;
   - продолжить как есть (только при явном подтверждении пользователя).

### 3.2 Поиск потенциальных секретов

Проверь staged-изменения на явные признаки секретов:
- API keys / tokens / private keys / passwords / connection strings.
- Паттерны вида `AKIA...`, `ghp_...`, `-----BEGIN PRIVATE KEY-----`, `password=`, `secret=`, `token=`.

Если найдено:
1. Покажи только безопасный контекст (без полного вывода секрета).
2. Останови авто-коммит.
3. Через `ask_questions` предложи:
   - удалить/замаскировать секреты и продолжить;
   - если это .env создать .env.example и обновить .gitignore; 
   - исключить файл из stage;
   - отменить операцию.

### 3.3 Поиск неуместных фраз и матершины в коде

Иногда так бывает, что у разработчика здают нервы, и он пишет в коде нецензурные выражения. Это может быть проблемой, если такие изменения попадут в историю. Поэтому стоит проверять staged-изменения на наличие таких фраз и предупреждать пользователя, сразу предлагая более нейтральные формулировки.

По этому:
- Проверь изменения на матершину и прочие NSFW вещи в коментариях, именах переменных и прочих текстовых изменениях.
- Если это часть локализации или "ассетов" - ок, пропускаем.

## Фаза 4: Формирование commit message

Сформируй сообщение в формате:

```text
<change_type>: <Short Change Description>

Detailed semantic description of changes
```

Где:
- `<change_type>` — один из: `feat`, `fix`, `refactor`, `docs`, `test`, `chore`, `build`, `ci`, `perf`, `revert`.
- `Short Change Description` — коротко, по сути, в одну строку.
- `Detailed semantic description` — 2+ строк с ключевыми изменениями (списоком, не файлы, а семантика), мотивацией и влиянием.

Правила качества commit message:
1. Заголовок до ~72 символов.
2. Без абстрактных формулировок вроде "misc updates".
3. Опираться только на реально staged изменения.
4. Семантические описания вместо конкретных файлов/строк.
4. Если staged содержит несколько несвязанных изменений — предложить пользователю разбить на несколько коммитов.

## Фаза 5: Выполнение commit

1. Выполни:
   - `git commit -m "<title>" -m "<body>"`
2. Если commit не выполнен (hook/validation failed) — покажи ошибку и предложи шаги исправления.

## Фаза 6: Отчёт пользователю

Выдай краткий отчёт:
1. Что было добавлено в stage.
2. Были ли найдены мусорные файлы/секреты и как решено.
3. Итоговый commit message.
4. Результат `git commit` (хеш и краткая сводка файлов).

## Требования к качеству

1. Не выводи секреты в открытом виде.
2. Не коммить без проверки staged-содержимого.
3. Если есть сомнения в корректности набора изменений — спроси пользователя через `ask_questions` перед commit.
4. Всегда явно предупреждай о рисках загрязнения истории бинарными артефактами и предлагай обновить `.gitignore`.
